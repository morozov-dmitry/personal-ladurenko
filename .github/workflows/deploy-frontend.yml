name: Deploy Frontend

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'front/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - prod

env:
  AWS_REGION: eu-central-1
  NODE_VERSION: '22'
  TERRAFORM_VERSION: '1.5.7'

jobs:
  build-and-test:
    name: Build and Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install pnpm
      run: npm install -g pnpm

    - name: Verify directory structure
      run: |
        echo "Current directory contents:"
        ls -la
        echo "Front directory contents:"
        ls -la front/

    - name: Install dependencies
      run: |
        cd front
        pnpm install --frozen-lockfile

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TERRAFORM_VERSION || '1.5.7' }}

    - name: Configure AWS credentials for Terraform
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Get Terraform outputs
      id: terraform-outputs
      run: |
        # Determine environment based on branch or manual input
        if [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENV="prod"
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          ENV="staging"
        else
          ENV="${{ github.event.inputs.environment || 'staging' }}"
        fi
        
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        
        # Get Terraform outputs
        cd infrastructure/environments/$ENV
        terraform init -backend-config="bucket=lostal-terraform-state" -backend-config="key=$ENV/terraform.tfstate" -backend-config="region=eu-central-1"
        
        # Extract outputs with better error handling
        echo "Getting Terraform outputs for environment: $ENV"
        terraform output
        
        BASE_URL=$(terraform output -raw base_url 2>/dev/null || echo "")
        API_BASE_URL=$(terraform output -raw api_gateway_url 2>/dev/null || echo "")
        GOOGLE_ANALYTICS_ID=$(terraform output -raw google_analytics_id 2>/dev/null || echo "")
        GOOGLE_ADS_ID=$(terraform output -raw google_ads_id 2>/dev/null || echo "")
        GOOGLE_ADS_CONVERSION_ID=$(terraform output -raw google_ads_conversion_id 2>/dev/null || echo "")
        
        # Validate API_BASE_URL
        if [ -z "$API_BASE_URL" ]; then
          echo "ERROR: API Gateway URL is empty! Terraform output failed."
          exit 1
        fi
        
        echo "base_url=$BASE_URL" >> $GITHUB_OUTPUT
        echo "api_base_url=$API_BASE_URL" >> $GITHUB_OUTPUT
        echo "google_analytics_id=$GOOGLE_ANALYTICS_ID" >> $GITHUB_OUTPUT
        echo "google_ads_id=$GOOGLE_ADS_ID" >> $GITHUB_OUTPUT
        echo "google_ads_conversion_id=$GOOGLE_ADS_CONVERSION_ID" >> $GITHUB_OUTPUT
        
        echo "Environment: $ENV"
        echo "Base URL: $BASE_URL"
        echo "API Base URL: $API_BASE_URL"
        echo "Google Analytics ID: $GOOGLE_ANALYTICS_ID"

    - name: Generate Static Site
      run: |
        cd front
        echo "Environment variables for build:"
        echo "NUXT_PUBLIC_API_BASE_URL=$NUXT_PUBLIC_API_BASE_URL"
        echo "NUXT_PUBLIC_GOOGLE_ANALYTICS_ID=$NUXT_PUBLIC_GOOGLE_ANALYTICS_ID"
        echo "NUXT_PUBLIC_GOOGLE_ADS_ID=$NUXT_PUBLIC_GOOGLE_ADS_ID"
        echo "NUXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID=$NUXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID"
        pnpm run generate
      env:
        NUXT_PUBLIC_API_BASE_URL: ${{ steps.terraform-outputs.outputs.api_base_url }}
        NUXT_PUBLIC_GOOGLE_ANALYTICS_ID: ${{ steps.terraform-outputs.outputs.google_analytics_id }}
        NUXT_PUBLIC_GOOGLE_ADS_ID: ${{ steps.terraform-outputs.outputs.google_ads_id }}
        NUXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID: ${{ steps.terraform-outputs.outputs.google_ads_conversion_id }}

    - name: Copy default locale to root for SEO
      run: |
        cd front/.output/public
        # Copy Ukrainian (default locale) content to root for SEO
        if [ -d "uk" ]; then
          echo "Copying uk/index.html to root index.html for SEO"
          cp uk/index.html index.html
          
          # Fix asset paths in the copied index.html
          echo "Fixing asset paths in root index.html"
          sed -i 's|href="/uk/_nuxt/|href="/_nuxt/|g' index.html
          sed -i 's|src="/uk/_nuxt/|src="/_nuxt/|g' index.html
          sed -i 's|href="/uk/ogMainImage|href="/ogMainImage|g' index.html
          sed -i 's|src="/uk/ogMainImage|src="/ogMainImage|g' index.html
          
          # Copy _nuxt directory to root if it doesn't exist
          if [ -d "uk/_nuxt" ] && [ ! -d "_nuxt" ]; then
            echo "Copying _nuxt directory to root"
            cp -r uk/_nuxt ./
          fi
          
          # Copy any other assets that might be referenced from root
          if [ -f "uk/ogMainImage.jpeg" ] && [ ! -f "ogMainImage.jpeg" ]; then
            echo "Copying ogMainImage.jpeg to root"
            cp uk/ogMainImage.jpeg ./
          fi
          
          echo "Root index.html created for SEO with fixed asset paths"
          echo "Checking asset paths in root index.html:"
          grep -E "(href|src).*/(_nuxt|ogMainImage)" index.html | head -5
        else
          echo "Warning: uk directory not found, skipping root copy"
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-build
        path: front/.output/public/
        retention-days: 1

  deploy-staging-frontend:
    name: Deploy Frontend to Staging
    runs-on: ubuntu-latest
    needs: build-and-test
    if: (github.ref == 'refs/heads/develop' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./build/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        aws s3 sync ./build/ s3://lostal-staging-site/ --delete
        echo "Frontend deployed to staging S3 bucket"

    - name: Invalidate CloudFront
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, 'lostal-staging-site')].Id" --output text)
        aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
        echo "CloudFront cache invalidated for staging"

    - name: Output Staging Frontend URL
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, 'lostal-staging-site')].Id" --output text)
        DOMAIN=$(aws cloudfront get-distribution --id $DISTRIBUTION_ID --query "Distribution.DomainName" --output text)
        echo "## Staging Frontend Deployed ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://$DOMAIN" >> $GITHUB_STEP_SUMMARY

  deploy-prod-frontend:
    name: Deploy Frontend to Production
    runs-on: ubuntu-latest
    needs: build-and-test
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod')
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: frontend-build
        path: ./build/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to S3
      run: |
        aws s3 sync ./build/ s3://lostal-prod-site/ --delete
        echo "Frontend deployed to production S3 bucket"

    - name: Invalidate CloudFront
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, 'lostal-prod-site')].Id" --output text)
        aws cloudfront create-invalidation --distribution-id $DISTRIBUTION_ID --paths "/*"
        echo "CloudFront cache invalidated for production"

    - name: Output Prod Frontend URL
      run: |
        DISTRIBUTION_ID=$(aws cloudfront list-distributions --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, 'lostal-prod-site')].Id" --output text)
        DOMAIN=$(aws cloudfront get-distribution --id $DISTRIBUTION_ID --query "Distribution.DomainName" --output text)
        echo "## Production Frontend Deployed ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://$DOMAIN" >> $GITHUB_STEP_SUMMARY
